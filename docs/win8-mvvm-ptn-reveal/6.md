# 六、HTML5 和 JavaScript 中的视图、模型和视图模型结构

就在 Windows 8 发布的时候，我正在完成这本书的最后一章！我非常兴奋地看到，微软的新操作系统正在交付，这有望带来下一代触摸优化的 Windows 商店应用。

不再浪费时间，让我们按照 MVVM 设计模式，使用 HTML5 和 JavaScript 实现 FinanceHub Windows 8 应用。在本章中，我们将通过以下主要步骤来开发该应用:

*   使用导航 Windows 8 JavaScript 应用项目模板设置初始项目
*   实现视图
*   实现模型
*   实现视图模型
*   使用状态持久性实现脱机存储

设置 FinanceHub JavaScript Windows 8 应用项目

类似于 Windows 8 XAML 应用项目模板(针对 Visual C#、Visual Basic .NET 和 Visual C++)，Visual Studio 2012 为 JavaScript 提供了一些默认的 Windows 8 应用项目模板，如空白应用、网格应用、拆分应用、固定布局应用和导航应用模板。

让我们使用 JavaScript 导航 JavaScript Windows 8 应用项目模板创建一个 FinanceHub Windows 8 应用。在 Visual Studio 2012 中点击*新建项目*选项；如果你有默认语言选择 Visual C#，那么你会在 Visual Studio 2012 的新项目窗口的*其他语言*部分找到 JavaScript 的 Windows 8 应用项目模板。选择*导航 App* Windows 8 应用项目模板，浏览至所需文件夹，将项目命名为 *FinanceHub* 。现在单击 OK 创建一个新项目。您会注意到创建了一个新文件夹 *FinanceHub* ，并且在您选择的文件夹下创建了 Windows 8 JavaScript 导航应用项目。

探索建立金融枢纽工程

如果您打开 FinanceHub 项目并查看解决方案资源管理器窗口，您会发现导航 JavaScript Windows 8 应用项目结构有点类似于您在使用 XAML Windows 8 应用项目创建 FinanceHub 应用时看到的结构。

默认项目结构

基于 JavaScript 导航模板的项目结构的基础有点类似于我们在第 1 章中经历的基于 XAML 的空白 Windows 8 应用结构的基础。让我们快速看一下项目的关键文件/文件夹:

*   根项目文件夹下的*default.html*文件是一个主 HTML 页面，它定义了页面布局的结构，是一个默认的启动页面，将在您运行应用时首先加载。请注意，您可以通过 *package.appxmanifest* 文件更改默认启动页面。
*   在 *js* 文件夹下， *default.js* 文件可用，这是一个启动的、与页面相关的、代码隐藏的 JavaScript 文件，基本上在项目开始时运行，是管理数据和用户交互的关键文件。它还包含 *navigator.js* 文件，该文件默认情况下作为导航项目模板的一部分添加，用于支持导航，并提供从一个页面导航到另一个页面所需的容器。
*   在 *css* 文件夹下， *default.css* 文件是可用的，它提供了一组将应用于 HTML 页面的默认样式。
*   *引用*文件夹包含一组 JavaScript 和 CSS 文件，用于开发和运行 Windows 8 应用，并提供应用的默认主题。
*   在 *images* 文件夹下，( *Assets* 文件夹用于基于 XAML 的 Windows 8 应用项目)，存在一组 4 个 PNG 图标图像，它们由应用清单使用，定义默认应用徽标(大的和小的应用徽标显示在开始屏幕上，应用徽标显示在 Windows 商店上)和闪屏(当应用启动时显示)。
*   与基于 XAML 的 Windows 8 应用项目类似， *package.appxmanifest* 文件是一个重要的文件，它定义了运行时配置属性，如名称、起始页、描述、磁贴相关信息、通知和闪屏，并启用了 Windows 8 应用部署包的功能。打开*应用 UI* 选项卡，将闪屏的*背景*颜色设置为 *#9ea7b1* 。
*   还添加了一个附加文件夹 *pages* ，其中包含导航项目的默认主页。我们不需要这个，因为我们要创建自己的视图。继续删除整个文件夹。

在金融中心项目中设置 MVVM 建筑

到目前为止，我们看了默认的 JavaScript Windows 8 应用结构。接下来，我们将添加一些额外的文件夹来支持使用 MVVM 设计模式的 FinanceHub 项目的设计和开发。

请添加以下四个文件夹作为占位符，以支持 MVVM 设计模式:

*   common–该文件夹将包含必需的通用 JavaScript 文件。
*   model——这个文件夹将包含 JavaScript 文件来实现应用的模型。
*   view–该文件夹将包含由不同 HTML 页面和相关 JavaScript 文件以及相关样式表组成的用户界面定义。
*   ViewModel–该文件夹将包含实现 pages/usercontrols 的 ViewModel 的 JavaScript 文件。

添加应用徽标文件和闪屏

要为 FinanceHub 应用提供定制品牌，接下来定义定制应用徽标和闪屏。为此，首先用[第 6 章](6.html)源代码提供的*splashscreen.png*和*storelogo.png*文件替换默认的闪屏和 storelogo 文件。然后将附加图片(可在[第六章](6.html)源代码中获得)*AppLogo.png*、*up.png*、*down.png*拖拽到项目的*图片*文件夹中。

实现视图

作为实现 FinanceHub 应用的视图(用户界面)的一部分，我们需要添加定制的 HTML 页面来定义 StockPage 和 StockDetails 页面，并将更新启动默认 HTML 页面来合并这些新添加的页面，以及定义 add 和 remove stock 弹出按钮。我们开始吧。

添加 StockPages.html 页面控件

选择*视图*文件夹，点击添加新项目，添加一个名为 StocksPage.html*的新页面控件。你会注意到在*视图*文件夹下添加了三个文件——【StocksPage.html】*、 *StocksPage.css* 和*stocks page . js——*。当您添加任何 JavaScript 类型的页面控件时，一个新的 HTML 文件以及相应的 CSS 和 JavaScript 文件将被添加到项目中。T13】

打开*StocksPage.html*文件，定位*标题*标签，其中 *aria-label* 设置为*标题内容*，更新以下高亮显示的项目，添加新的应用徽标，并将页面标题更改为*金融中心*。

```cs
<header aria-label="Header content" role="banner">
    <button class="win-backbutton" aria-label="Back" disabled></button>
    <img src="..\\images\AppLogo.png"
        style="height:80px;width:80px;margin-left:110px;margin-top:40px" />
    <h1 class="titlearea win-type-ellipsis"
style="margin-left:90px" >
        <span class="pagetitle">
Finance Hub </span>
    </h1>
</header>
```

接下来，让我们定义显示库存商品和商品文本所需的键样式。打开 *StocksPage.css* 文件，首先删除下面提到的现有样式:

```cs
.StocksPage p {
    margin-left: 120px;
}
```

现在添加以下新样式:

```cs
.StocksPage .itemslist .win-horizontal.win-viewport .win-surface {
    margin-bottom: 60px;
    margin-left: 115px;
    margin-top: 7px;
}

.StocksPage .itemslist {
    height: 100%;
    position: relative;
    width: 100%;
    z-index: 0;
}

.StocksPage .itemslist .win-item {
    background-color:#fff;
    padding:15px;
    height: 130px;
    width: 180px;
}

.StocksPage .itemtext {
 font-size:15pt;
 float: left;
 color:#808080;
}
```

我们已经准备好开始添加新的 WinJS 用户控件，开始定义 FinanceHub 应用的用户界面(视图)。

重新访问*StocksPage.html*文件，寻找*节*标签，它就位于*头*标签的下面。首先删除现有的以下内容:

```cs
<p>Content goes here.</p>
```

现在添加一个新的 *WinJS。UI.ListView* 控件，如下图*部分*标签下所示:

```cs
<section aria-label="Main content" role="main">
    <div class="itemslist"
            data-win-control="WinJS.UI.ListView"
            data-win-options="{ selectionMode: 'none'}"></div>
</section>
```

接下来让我们为上面添加的 *WinJS 定义一个项目模板。如下所示的*主体*标签内的 UI.ListView* 控件，用于显示 *ListView* 控件中的每一项:

```cs
<body>
<!-- This template is used to display each item in the ListView declared below. -->
    <div class="itemtemplate" data-win-control="WinJS.Binding.Template">
       <div >
           <h2 style="color:#4E6485"></h2>
           <div class="itemtext">Open</div>
           <div style="margin-left:85px;font-size:15pt;color:#6a7bba"></div>
           <div class="itemtext" >Change</div>
           <div style="margin-left:85px;font-size:15pt;" >
           <div></div></div>
           <div style="float: left;margin-left:15px;margin-top:15px">
               <img style="height:25px" />
           </div>
           <div style="margin-left:85px;margin-top:10px;font-size:20pt;color:#759CC8">
           </div>
       </div>
    </div>
    ....
</body>
```

注意，这个模板仍然没有完全定义。缺少的大部分是绑定模板，我们将在本章的后面实现应用的视图模型。

接下来跳转到 *StocksPage.js* 文件，我们将把上面定义的项目模板应用到 *ready* 事件处理程序中的 *ListView* 中，如下所示:

```cs
ready: function (element, options) {
    // TODO: Initialize the page here.
    var listView = element.querySelector(".itemslist").winControl;
    listView.itemTemplate = element.querySelector(".itemtemplate");
    listView.element.focus();
},
```

最后打开*Default.html*文件，将*StocksPage.html*设置为主页，在 *body* 标签下，更新*应用的现有*content host data-win-control*。PageControlNavigator* 通过设置 *data-win-options* 将主页指向*StocksPage.html*，如下图所示。

```cs
<body>
    <div id="contenthost"
            data-win-control="Application.PageControlNavigator"
            data-win-options="{home:'/View/StocksPage.html' }"></div>
</body>
```

此时，如果您编译该项目并在模拟器模式下运行它，您应该会看到一个自定义的 FinanceHub 闪屏和一个主应用启动页面，其中有 FinanceHub 应用徽标和应用标题，但没有任何内容。相信我，这是一个好的开始！

我们将在本章的后面部分再次访问这一页，以完成数据绑定的实现。

添加 StockDetails.html 页面控件

选择*视图*文件夹，点击 Add New Item 添加一个名为【StockDetails.htmlT2】的新页面控件，该控件位于 JavaScript 选项卡下。您会注意到在*视图*文件夹下添加了三个文件——【StockDetails.html】、 *StocksDetails.css* 和*stocks details . js——*(当您添加任何 JavaScript 类型的页面控件时)。T13】

打开*StockDetails.html*文件，找到*头*标签，其中 *aria-label* 设置为*头内容*。现在把页面标题改成*金融枢纽*。

```cs
<header aria-label="Header content" role="banner">
    <button class="win-backbutton" aria-label="Back" disabled></button>
    <h1 class="titlearea win-type-ellipsis">
        <span class="pagetitle">Finance Hub </span>
    </h1>
</header>
```

要定义显示股票详细信息和标题信息所需的关键样式，打开 *StockDetails.css* 文件，首先删除下面提到的现有样式:

```cs
.StockDetails p {
    margin-left: 120px;
}
```

接下来添加以下新样式:

```cs
.StockDetails {
    -ms-grid-columns: 350px 1fr;
    display: -ms-grid;
    height: 100%;
    width: 100%;
}

    .StockDetails .itemlistsection {
        -ms-grid-row: 2;
        margin-left: 106px;
    }

        .StockDetails .itemlistsection .itemlist {
            height: 100%;
            position: relative;
            width: 100%;
            z-index: 0;
        }

    .StockDetails .itemlistsection .itemlist .win-item {
        background-color:#fff;
        -ms-grid-columns: 110px 1fr;
        -ms-grid-rows: 1fr;
        display: -ms-grid;
        height: 90px;
        width: 180px;
        padding:10px;
    }

    .StockDetails .detailsection {
        -ms-grid-column: 2;
        -ms-grid-row-span: 2;
        -ms-grid-row: 1;
        margin-left: 70px;
        margin-top: 120px;
        overflow-y: auto;
        padding-right: 120px;
        position: relative;
        z-index: 0;
    }

.captionStyle {
        color:#fff;
        font-weight:500;
        font-size:16pt;

}

.detailStyle {
        color:#0026ff;
        font-weight:500;
        font-size:16pt;
        margin-bottom:10px;
}

.headerStyle {
        color:#6a7bba;
        font-weight:600;
}
```

我们已经准备好开始添加新的 WinJS 用户控件，开始定义 FinanceHub 应用股票详细信息的用户界面(视图)。

重新访问*StockDetails.html*文件，寻找*节*标签，它就位于*头*标签的下面。首先删除现有的以下内容:

```cs
<section aria-label="Main content" role="main">
    <p>Content goes here.</p>
</section>
```

现在添加一个新的 *WinJS。UI.ListView* 控件，如下图所示:

```cs
<div class="itemlistsection">
    <div class="itemlist" id="itemlistView"
             data-win-control="WinJS.UI.ListView"
             data-win-options="{ selectionMode: 'single', tapBehavior: 'toggleSelect'}">
    </div>
</div>
<div class="detailsection" id="stockInfoView" aria-atomic="true"
         aria-live="assertive">
    <h2 class="headerStyle" >Stock Details</h2>
    <div class="captionStyle">Current Price</div>
    <div class="detailStyle" ></div>
    <div class="captionStyle">Open Price</div>
    <div class="detailStyle" ></div>
    <div class="captionStyle">Today High and Low Range</div>
    <div class="detailStyle" ></div>
    <div class="captionStyle">52 Weeks High and Low Range</div>
    <div class="detailStyle" ></div>
</div>
```

接下来为上面添加的 *WinJS 定义一个项目模板。如下所示的*主体*标签内的 UI.ListView* 控件，用于显示 *ListView* 控件中的每一项:

```cs
<body>
    <div class="itemtemplate" data-win-control="WinJS.Binding.Template">
         <div>
           <h2 style="color:#4E6485"></h2>
           <div style="font-size:15pt;float: left; color:#808080">Open</div>
           <div style="margin-left:85px;font-size:15pt;color:#6a7bba" ></div>
           <div style="font-size:15pt;float: left; color:#808080">Change</div>
            <div style="margin-left:85px;font-size:15pt;"><div></div></div>
         </div>
    </div>
    ....
</body>
```

接下来跳转到 *StockDetails.js* 文件，我们将把上面定义的项目模板应用到 *ready* 事件处理程序中的 *ListView* 中，如下所示:

```cs
(function () {
    "use strict";
    var ui = WinJS.UI;

    WinJS.UI.Pages.define("/View/StockDetails.html", {
        // This function is called whenever a user navigates to this page. It
        // populates the page elements with the app's data.
        ready: function (element, options) {
            // TODO: Initialize the page here.
            var listView = element.querySelector(".itemlist").winControl;
            listView.itemTemplate = element.querySelector(".itemtemplate");
            listView.layout = new ui.ListLayout();
        },
    ....
```

此时，如果您编译项目并在模拟器模式下运行它，您应该会看到相同的输出，一个自定义的 FinanceHub 闪屏和主应用启动页面，带有 FinanceHub 应用徽标和应用标题，但没有任何内容，如下面的[图 6-1](#Fig1) 所示。

![9781430249085_Fig06-01.jpg](img/-01.jpg)

[图 6-1。](#_Fig1)实现了部分视图的财务中心应用

我们将在本章的后面部分再次访问这一页，以完成数据绑定的实现。

增强 default.html 页面

*default.html*页面将作为母版页，并将包含额外的 *< div >* 标记，用于托管包含添加股票和删除股票按钮的 FinanceHub 应用的 Windows 8 应用栏。此页面还将包含添加和删除库存弹出按钮的标记。

添加应用栏

打开*default.html*页面，通过添加 *WinJS 添加应用栏。UI.AppBar* 控件，在 *body* 标签中 *contenthost* 的正下方有两个用于添加和删除股票动作的按钮。

```cs
<div id="appbar" data-win-control="WinJS.UI.AppBar" style="background-color:#9EA7B1">
    <button data-win-control="WinJS.UI.AppBarCommand"
        data-win-options=
            "{id:'cmdAdd',label:'Add',icon:'add',section:'global',tooltip:'Add',
                type:'flyout', flyout:'addStockFlyout'}">
    </button>
    <button data-win-control="WinJS.UI.AppBarCommand"
        data-win-options=
            "{id:'cmdDelete',label:'Remove',icon:'remove',section:'global',tooltip:'Delete',
                type:'flyout', flyout:'removeStockFlyout'}" >
    </button>
</div>
```

如上所述，我们已经使用*添加股票弹出按钮*和*移除股票弹出按钮*作为添加和移除股票按钮的*类型*值。让我们在添加的 appbar 代码下面定义这些弹出按钮。

添加“添加库存”弹出按钮

对于 *addStockFlyout* 我们将使用 *WinJS。UI .飞出式*控件将允许用户输入新的股票信息并将其添加到 appbar code 之后，如下所示:

```cs
<div id="addStockFlyout" data-win-control="WinJS.UI.Flyout" >
    <div id="addStockFlyoutMessage"></div>
    <input id="addStockText" placeholder="Enter a symbol (e.g., MSFT)" />
    <br /><br />
    <button id="addStockButton" style="color:#fff">Add</button>
    <br /><br />
</div>
```

添加“移除库存”弹出按钮

对于 *removeStockFlyout* 我们也将使用 *WinJS。UI .弹出*控件，将允许用户通过复选框从现有股票列表中选择一个或多个股票，然后删除选中的股票。为此，我们定义了一个带有输入控件的表，并在弹出菜单中添加了 span 标签，这是我们的项目模板，用于显示要用 checkbox 删除的股票列表。在 add stock 弹出代码之后立即添加以下代码来实现这一点。

```cs
<div id="removeStockFlyout" data-win-control="WinJS.UI.Flyout"
    data-win-options="{width:'wide'}" >
        <table>
            <tbody>
                <tr>
                    <td >
                        <input type="checkbox"/>
                         <span></span>
                    </td>
                </tr>
            </tbody>
        </table>
        <button id="Button1" style="color:#fff">Remove Selected</button>
        <br /><br />
</div>
```

在本章的后面，当我们实现 ViewModel 时，我们将使用 KnockoutJS 框架将数据绑定到这些弹出按钮。

此时，如果您编译项目并在模拟器模式下运行它，您应该会看到相同的输出，一个自定义的 FinanceHub 闪屏，然后是带有应用徽标的主应用页面和没有内容的应用。然而，这一次如果你在触摸屏模式下右击或从底部滑动，你会看到带有添加和删除股票按钮的应用栏，如图[图 6-2](#Fig2) 所示。

![9781430249085_Fig06-02.jpg](img/-02.jpg)

[图 6-2。](#_Fig2)实现了部分视图的财务中心应用

单击 Add 和 Remove 按钮，您应该会看到相关的弹出按钮显示出来(虽然还没有任何内容)！

实现转换器

我们需要开发两个 WinJS。Binding.converter 函数:一个用于显示上下箭头(使用 *images* 文件夹下添加的*up.png*和*down.png*图像)，第二个用于显示当前股票价值为红色或绿色字体，基于变化值为正(最终结果将是向上箭头和绿色字体)或负(最终结果将是向下箭头和红色字体)。

为此，在 *Common* 文件夹下添加一个新的 JavaScript 文件名 *Converters.js* ，并添加下面几行使用 *WinJS 定义这两个转换器的代码。Binding.converter* 并在 *FinanceHub 中公开它们。转换器*名称空间:

```cs
 (function () {
    "use strict";

    WinJS.Namespace.define("FinanceHub.Converters", {
        ChangeArrowConverter: WinJS.Binding.converter(function (value) {
            return value >= 0 ? "..\\images\\up.png" : "..\\images\\down.png";
        }),

        ChangeColorConverter: WinJS.Binding.converter(function (value) {
            return value >= 0 ? "#108104" : "#C02C01";
        })
    });
})();
```

创建 FinanceHub 应用品牌

您可以决定应用不同于默认的 Windows 样式库的独特的自定义应用，这可以通过重写 Windows 样式库来实现。在我们的例子中，我们需要应用我们选择的背景颜色和页面标题颜色。为此，在 *css* 文件夹下添加名为 *styles.css* 的新样式表，并添加以下代码:

```cs
body
{
  background-color:#B3BDE1;
}

.pagetitle
{
 color:#585A8E;
}
```

现在打开*default.html*，在已有的 *default.css* 引用下，添加对新添加的样式表 *styles.css* 的引用，如下:

```cs
<link href="/css/styles.css" rel="stylesheet" />
```

现在运行应用，你会看到背景色和标题文本前景色被应用在自定义样式表中，如图 6-3 中的[所示。](#Fig3)

![9781430249085_Fig06-03.jpg](img/-03.jpg)

[图 6-3。](#_Fig3)自定义风格的金融中心应用

实现模型

在前一节中，我们成功地实现了应用的视图构建关键用户界面的基础。现在是实现应用模型的时候了。当我们在第 3 章中为基于 XAML 的项目实现模型时，你会注意到实现非常简单。它包括股票信息的定义(作为一个类),还定义了一个本地数据源，该数据源将有助于以随机方式向您的应用提供所添加股票的模拟价格。

定义股票类别

股票数据模型需要一个数据模型，该模型至少实现一个支持属性的类，以支持关于股票的以下六条信息:

*   股票代码(如 MSFT)
*   股票当前价格(如 30.30)
*   股票开盘价(如 30.05)
*   今天股票价格的变化-正值或负值(例如+0.25)
*   范围-今天的最高价和最低价(例如 30.33 - 30.05)
*   范围- 52 周的最高价和最低价(例如 32.95 - 24.26)

为了包含上述信息，创建包含 Symbol、PercentChange、OpenPrice、ClosePrice、Change 和 DaysRange 属性的股票类对象。

在 JavaScript 世界中，我们将按照 JavaScript 模块模式定义单个模型类*股票*。因此，类定义格式通常如下所示:

```cs
(function () {
    "use strict";

    WinJS.Namespace.define("NameSpaceGoesHere ", {
        ClassName : WinJS.Class.define(
            function () {
            var self = this;
            //members initialization
            }
            //private members, methods and properties
    )}
    )
})();
```

接下来，首先选择模型文件夹，添加一个新的 JavaScript 文件，名为 *Stock.js* 。打开空白的 *Stock.js* 文件，添加以下代码，定义一个具有上述属性的股票类:

```cs
(function () {
    "use strict";

    WinJS.Namespace.define("FinanceHub.Model", {
        Stock: WinJS.Class.define(
            function (symbol, currentPrice, openPrice, change, daysRange, range52Week) {

                this.Symbol = symbol;
                this.OpenPrice = openPrice;
                this.CurrentPrice = currentPrice;
                this.Change = change;
                this.DaysRange = daysRange;
                this.Range52Week = range52Week;
            }
            , {

                Symbol: undefined,
                OpenPrice: undefined,
                CurrentPrice: undefined,
                Change: undefined,
                DaysRange: undefined,
                Range52Week: undefined
            }),
    });
})();
```

注意，这里我们已经在*金融中心定义了*股票*模型类。模型名称空间*。

添加 SimulatedRandomStocksDetail.csv 文件

如果您希望将此应用转换为商业 Windows 应用商店应用，您可能希望实时更新股票(添加到观察列表中)。为此，您可以使用服务提供商提供的股票更新服务(API ),如微软必应、雅虎或谷歌。为了简单起见，并专注于核心主题-为 Windows 8 应用实现 MVVM 模式-我们不会为“实时更新”执行与此类服务的集成但是，我们将模拟“实时更新”场景，在作为项目一部分存储的逗号分隔文件中添加一些股票详细信息的值，并从该文件中为观察列表中添加的每个股票随机选取值。

正如我们在第 3 章中所做的，在*模型*文件夹下创建一个名为*simulatedrandomstocksdail . CSV*的空文本文件。现在，您需要添加多个以逗号分隔的行，每一行都包含以下字段的以逗号分隔的值，这些字段按以下顺序排列(先提到的排在最前面，最后提到的排在最后):

*   股票当前价格(如 30.30)
*   股票开盘价(如 30.05)
*   今天股票价格的变化-正值或负值(例如+0.25)
*   范围-今天的最高价和最低价(例如 30.33 - 30.05)
*   范围- 52 周的最高价和最低价(例如 32.95 - 24.26)

作为示例，我在文件中添加了以下值:

```cs
15.02,14.99,0.04,14.85 - 15.07,12.45 - 16.79
675,672.87,4.27,671.70 - 677.25,480.60 - 677.25
21.07,21.05,-0.05,20.94 - 21.10,14.02 - 21.19
30.30,30.05,0.25,30.33 - 30.05,32.95 - 24.26
640,636.34,11.77,638.81 - 648.19,354.24 - 648.19
```

至此，我们已经完成了 FinanceHub 应用的轻量级模型类的实现。正如您已经注意到的，我们在本节中完成了所有的后端编码，因此与我们作为视图实现的一部分实现的内容相比，没有任何可视化的结果。然而，这是一个重建解决方案的最佳实践(通过按 F6 ),并确保你没有得到任何错误！

实现视图模型

到目前为止，我们已经通过构建应用的关键用户界面成功地实现了视图的基础，并通过实现前面部分中的数据模型和模拟数据源定义成功地实现了模型。现在是时候实现应用的视图模型了。

作为 ViewModel 实现的一部分，我们将实现关键的 ViewModel 类，这些类将支持将股票相关信息绑定到定义的视图，并支持添加和删除股票操作(使用 KnockoutJS 框架)。在这个实现过程中，我们将重新访问现有的视图，并更新它们以应用数据绑定。

此外，我们还将开发助手类来实现本地存储，支持对 CSV 格式存储的股票进行 CRUD 操作。

定义 StocksPageViewModel 类并绑定到视图

*StocksPageViewModel* 类是一个关键类，主要绑定所有与股票相关的视图——StocksPage 视图和 StockDetails 视图——以显示股票和相关信息。

添加 StocksPageViewModel 类

选择 *ViewModel* 文件夹，添加一个名为 *StocksPageViewModel.js* 的新 JavaScript 文件。首先，打开空白的 *StocksPageViewModel.js* 文件，添加下面的代码，定义一个名为*股票*的可绑定列表。稍后，我们将使用之前在模型文件夹中定义的*库存*模型的对象填充它:

```cs
(function () {
    "use strict";

    WinJS.Namespace.define("FinanceHub.ViewModel", {
        StocksPageViewModel: WinJS.Class.define(
            function () {
                var self = this;
                self.stocks = new WinJS.Binding.List();
                self.stocks.push(new FinanceHub.Model.Stock
                    ("MSFT", 25, 24, 2, "24.59 - 25.92", "23.22 - 25.76"));

                //Expose the data source
                WinJS.Namespace.define("FinanceHub.Data", {
                    Stocks: self.stocks
                });
            }
            , {
                stocks: undefined,
            }),
    });
})();
```

如你所见，WinJS。股票的 Binding.List 被定义并暴露在名称空间 *FinanceHub 中。数据*以便你可以与*StocksPage.html*的*列表视图*控件绑定。请注意，我还添加了一个样本股票 MSFT，以便我们可以看到一个单一的瓷砖一旦我们完成绑定到视图。

现在我们需要绑定先前定义的*股票页面*和*股票详细信息*视图，这样我们就可以看到样本 MSFT 股票。

为此，首先你需要打开他们所有的 HTML 文件，*default.html*，*StocksPage.html*，和*StockDetails.html*，并在 *head* 标签下添加以下添加的 JavaScript 文件引用。

```cs
<!--Reference to model and view model js files -->
<script src="/Common/Converters.js"></script>
<script src="/Model/Stock.js"></script>
<script src="/ViewModel/StocksPageViewModel.js"></script>
```

请注意，这里上面添加 JavaScript 文件作为引用的顺序很重要，因为 *StocksPageViewModel.js* 引用的是 *Stock.js* 中定义的*股票*类，所以应该在引用 ViewModel 之前引用。

绑定库存视图

从*视图*文件夹中打开*StocksPage.html*，对已有的 *itemtemplate* 进行绑定，如下图粗体所示:

```cs
<div class="itemtemplate" data-win-control="WinJS.Binding.Template">
   <div >
       <h2
data-win-bind="textContent:Symbol" style="color:#4E6485"></h2>
       <div class="itemtext">Open</div>
       <div style="margin-left:85px;font-size:15pt;color:#6a7bba"
            data-win-bind="innerText:OpenPrice" ></div>
       <div class="itemtext" >Change</div>
       <div style="margin-left:85px;font-size:15pt;"
             data-win-bind=
                 "style.color:Change FinanceHub.Converters.ChangeColorConverter" >
       <div
data-win-bind="innerText:Change" ></div></div>
       <div style="float: left;margin-left:15px;margin-top:15px">
       <img
data-win-bind="src:Change FinanceHub.Converters.ChangeArrowConverter"
           style="height:25px" /></div>
       <div style="margin-left:85px;margin-top:10px;font-size:20pt;color:#759CC8"
           data-win-bind="innerText:CurrentPrice" ></div>
   </div>
</div>
```

您会注意到，我们使用 WinJS 控件的*data-win-bind*attribute/property 将元素与 ViewModel 中定义的数据源绑定在一起。注意，我们还在绑定元素中使用了两个以前开发的转换器函数。

接下来查找*部分*标签，并为 *WinJS 的 *itemDataSource* 属性应用绑定。UI.ListView* 控件，如下(粗体):

```cs
<div class="itemslist"
        data-win-control="WinJS.UI.ListView"
        data-win-options=
            "{ selectionMode: 'none'
, itemDataSource: FinanceHub.Data.Stocks.dataSource }">
</div>
```

更新 default.js 文件

接下来打开 *js* 文件夹下的 *default.js* 文件，在*激活的*事件处理程序中，查找以下注释文本:

```cs
// TODO: This application has been newly launched. Initialize
// your application here.
```

添加以下代码行:

```cs
var vm = new FinanceHub.ViewModel.StocksPageViewModel();
var pageVM = WinJS.Binding.as(vm);
WinJS.Binding.processAll(document.body, pageVM);
```

在上面的代码中，第一行初始化了 *StocksPageViewModel* 类的新实例。第二行从现有的 JavaScript 对象 *vm* 创建一个名为 *pageVM* 的可观察对象。这个新对象也具有原始对象 *vm* 的所有属性。除此之外，当属性改变时，可观察的 *pageVM* 对象的属性触发通知。第三行中的 *WinJS。Binding.processAll()* 方法被调用来执行实际的绑定。传递给 *processAll()* 方法的第一个参数表示绑定的根元素。因此绑定将发生在这个元素及其子元素上。如果提供的*为空*值，则绑定发生在*文档*的整个主体上，即*文档体*。第二个参数表示数据上下文。这是具有属性的对象，这些属性与*数据绑定*属性一起显示。

现在运行这个应用，你应该在主页上看到一个默认的 MSFT 股票和相关的股票信息，如图 6-4 所示，但是当你点击它的时候没有导航到 StockDetails 视图。

![9781430249085_Fig06-04.jpg](img/-04.jpg)

[图 6-4。](#_Fig4)将股票信息绑定到股票页面视图

连接导航–库存视图到库存详细信息视图

现在，当你从主页点击/选择一只股票时，从*StocksPage.html*连接导航到*StockDetails.html*页面。为此，从 ViewModel 中打开 *StocksPageViewModel.js* ，并添加以下突出显示的代码:

```cs
 (function () {
    "use strict";

    WinJS.Namespace.define("FinanceHub.ViewModel", {
        StocksPageViewModel: WinJS.Class.define(
            function () {
                var self = this;
                self.stocks = new WinJS.Binding.List();
                self.stocks.push(new FinanceHub.Model.Stock
                    ("MSFT", 25, 24, 2, "24.59 - 25.92", "23.22 - 25.76"));
                WinJS.Utilities.markSupportedForProcessing(this.stockClicked);
WinJS.Utilities.markSupportedForProcessing(this.stockSelectionChanged);

                //Expose the data source
                WinJS.Namespace.define("FinanceHub.Data", {
                    Stocks: self.stocks

                });

                //Expose the events and methods
                WinJS.Namespace.define("FinanceHub.Command", {
                    StockClicked: self.stockClicked,
                    StockSelectionChanged: self.stockSelectionChanged,
                });
            }
            , {
                stocks: undefined,
                stockClicked: function (e) {
WinJS.Navigation.navigate("/View/StockDetails.html").then(function () {

                        FinanceHub.Command.StockSelectionChanged(e);

                    });
                },

                stockSelectionChanged: function (e) {
                    var ele = document.getElementById('stockInfoView');
                    WinJS.Binding.processAll(ele,
                        FinanceHub.Data.Stocks.getAt(e.detail.itemIndex));
                },
            }),
    });
})();
```

这里，我们使用了 *WinJS。Navigation.navigate* 方法导航到*StockDetails.html*页面。我们使用 promise 对象并调用驻留在 *FinanceHub 中的 *StockSelectionChanged* 函数。命令*命名空间。 *StockSelectionChanged* 函数设置为当前点击的股票( *e.detail.itemIndex* )作为 *StockDetails* 页面中 *stockInfoView* 元素的数据上下文。因此，每当用户点击股票页面上的任何股票时， *stockClicked* 事件将被触发，它将导航到股票详情页面，而 *stockSelectionChanged* 事件将设置被点击的股票信息。这段代码的重要部分是 *WinJS。utilities . marksupportedforprocessing*，它实际上将一个函数标记为与声明性处理兼容。声明性处理由 *WinJS 执行。Binding.processAll* 。

接下来你需要将 *StockClicked* 事件绑定到【StocksPage.html】的*文件中。为此，打开*StocksPage.html*页面，定位*部分*标签，修改 *WinJS 的 *data-win-options* 属性。UI.ListView，*如下(高亮文本)，为 *oniteminvoked* 事件添加绑定。*

```cs
<section aria-label="Main content" role="main">
    <div class="itemslist"
            data-win-control="WinJS.UI.ListView"
            data-win-options="{ selectionMode: 'none',
                                              itemDataSource: 
FinanceHub.Data.Stocks.dataSource,

oniteminvoked:FinanceHub.Command.StockClicked }">
    </div>
</section>
```

绑定库存详细信息视图

此时，从股票页面单击 MSFT 股票应该可以了，但是在股票详细信息页面上仍然没有显示任何详细信息。为了绑定 StockDetails 视图，我们需要在*StockDetails.html*页面中应用绑定。打开*StockDetails.html*页面，按照以下步骤操作:

修改下面突出显示的 *itemtemplate、*，以添加绑定:

```cs
<div class="itemtemplate" data-win-control="WinJS.Binding.Template">
     <div>
           <h2
data-win-bind="textContent:Symbol" style="color:#4E6485"></h2>
           <div style="font-size:15pt;float: left; color:#808080">Open</div>
           <div style="margin-left:85px;font-size:15pt;color:#6a7bba"
               data-win-bind="innerText:OpenPrice" ></div>
           <div style="font-size:15pt;float: left; color:#808080">Change</div>
           <div style="margin-left:85px;font-size:15pt;"
              data-win-bind=
                  "style.color:Change FinanceHub.Converters.ChangeColorConverter" >
              <div
data-win-bind="innerText:Change" ></div>
           </div>
    </div>
</div>
```

修改 *WinJS 的绑定。UI.ListView* 控件 *itemlistview，*如下:

```cs
<div class="itemlistsection">
    <div class="itemlist" id="itemlistView"
             data-win-control="WinJS.UI.ListView"
             data-win-options="{ selectionMode: 'single', tapBehavior: 'toggleSelect',
                 itemDataSource: FinanceHub.Data.Stocks.dataSource,
                 oniteminvoked:FinanceHub.Command.StockSelectionChanged }">
    </div>
</div>
```

修改 *detailsection div* 标签，如下图所示，添加股票信息绑定:

```cs
<div class="detailsection" id="stockInfoView" aria-atomic="true" aria-live="assertive">
    <h2 class="headerStyle" >Stock Details</h2>
    <div class="captionStyle">Current Price</div>
    <div class="detailStyle"data-win-bind="innerText:CurrentPrice" ></div>
    <div class="captionStyle">Open Price</div>
    <div class="detailStyle"data-win-bind="innerText:OpenPrice" ></div>
    <div class="captionStyle">Today High and Low Range</div>
    <div class="detailStyle"data-win-bind="innerText:DaysRange" ></div>
    <div class="captionStyle">52 Weeks High and Low Range</div>
    <div class="detailStyle"
data-win-bind="innerText:Range52Week" ></div>
</div>
```

现在运行应用，您应该会在主页上看到一只默认的 MSFT 股票以及相关的股票信息。此时，如果您点击/选择股票，您将进入股票详细信息页面，其中包含 MSFT(所选)的股票信息，如图[图 6-5](#Fig5) 所示。

![9781430249085_Fig06-05.jpg](img/-05.jpg)

[图 6-5。](#_Fig5)将股票信息与股票详细信息视图绑定

实现本地存储助手类

到目前为止，我们已经取得了相当大的进展。该应用运行正常，但只有默认的 MSFT 股票。现在让我们实现这个特性的基础，这样您就可以添加额外的股票，并且可以从包含随机股票信息的模拟样本 CSV 文件中检索股票值。

本节将在*公共*文件夹中实现一个本地存储助手类，这将允许我们读取和解析在*模型*文件夹下可用的 CSV—*simulatedrandomstocksdail . CSV—*。

要创建这个类，选择 *Common* 文件夹，添加一个 JavaScript 文件作为名为 *LocalStorageHelper.js* 的新项目，并添加以下代码，在 *FinanceHub 下创建这个类。LocalStorageHelper* 名称空间。

```cs
(function () {
    "use strict";

    WinJS.Namespace.define("FinanceHub.LocalStorageHelper", {

        ParseCSV: function (data) {
            var allTextLines = data.split(/\r\n|\n/);
            var rows = [];

            for (var i = 0; i < allTextLines.length; i++) {
                var data = allTextLines[i].split(',');
                var temp = [];
                for (var j = 0; j < data.length; j++) {
                    temp.push(data[j]);
                }
                rows.push(temp);
            }
            return rows;
        },
    });
})();
```

这里我们创建了一个函数 *ParseCSV，它*将接受字符串作为参数，然后将数据分割并返回一个结果字符串数组。

接下来，在 *ParseCSV* 函数的正下方添加一个额外的 *GetRandomStockData* 函数，该函数将读取 *Model* 文件夹下的*simulatedrandomstocksdail . CSV*文件，并调用 *ParseCSV* 函数来解析该文件的每条记录。以下是相关代码:

```cs
GetRandomStockData: function () {
    var url = "/Model/SimulatedRandomStocksDetail.csv";
        return WinJS.xhr({ url: url }).then(function (response) {
    return FinanceHub.LocalStorageHelper.ParseCSV(response.responseText);
    });
},
```

这里我们使用了 *WinJS.xhr* 函数来获取文件。这个函数将对 *XMLHttpRequest* 的调用包装在一个 promise 对象中。这个函数可以用来调用 web 服务，上传和下载文件。

![image](img/.jpg) **注**您可以通过访问微软 MSDN 网站*[http://msdn . Microsoft . com/en-us/library/windows/apps/br 229787 . aspx](http://msdn.microsoft.com/en-us/library/windows/apps/br229787.aspx)*获取更多关于 *WinJS.xhr* 函数的信息。

最后一步是在项目中添加对这个 JavaScript 文件的引用。为此，打开*default.html*文件并使用*脚本*标签添加对 *LocalStorageHelper.js* 文件的引用，该文件位于*公共*文件夹下，在*引用模型和查看模型 js 文件*部分下。

```cs
<script src="/Common/LocalStorageHelper.js"></script>
```

定义 AddandRemoveStockViewModel 类并绑定到视图

添加本地存储助手类后，现在为添加和删除弹出按钮构建一个视图模型，这将使我们能够添加和删除股票。正如在第 5 章中提到的，我们将使用 KnockoutJS 框架来实现这个视图模型。我们开始吧。

设置项目以使用 KnockoutJS 库

通过访问位于*[【http://knockoutjs.com/documentation/installation.html](http://knockoutjs.com/documentation/installation.html)*的 KnockoutJS 网站的文档部分获得最新的 KnockoutJS 库，并将最新的 JavaScript 库文件下载到您的本地文件夹中。在撰写本章时，最新的库版本是 2.0.0，文件名是 *knockout-2.0.0.js* 。

现在访问 *FinanceHub* 项目的 *js* 文件夹，通过使用 Add Existing Item 选项并浏览到下载文件的本地文件夹，添加下载的 KnockoutJS JavaScript 库文件。

最后一步是在项目中添加对这个 JavaScript 文件的引用。为此，打开*default.html*文件并使用*脚本*标签添加对 *knockout-2.0.0.js* 文件的引用，该文件位于 *js* 文件夹下，在*引用模型和查看模型 js 文件*部分下。

```cs
<script src="/js/knockout-2.0.0.js"></script>
```

添加 AddRemoveStockViewModel 类

选择 *ViewModel* 文件夹，添加一个名为*addremovestockviewmodel . js*的新 JavaScript 文件。接下来我们将向这个类添加两个函数，这将帮助我们添加股票和删除股票；这就是我们将使用 KnockoutJS JavaScript 库的地方。

现在打开*default.html*文件并使用*脚本*标签添加对*addremovestockviewmodel . js*文件的引用，该文件位于 *ViewModel* 文件夹下的*引用模型和视图模型 js 文件*部分下。

```cs
<script src="/ViewModel/AddRemoveStockViewModel.js"></script>
```

向视图模型添加添加股票功能

打开空白的*addremovestockviewmodel . js*文件，添加以下定义添加股票功能 T3 的代码:

```cs
 (function () {
    "use strict";

    WinJS.Namespace.define("FinanceHub.ViewModel", {
        AddRemoveStockViewModel: WinJS.Class.define(
            function () {

                var self = this;
                self.symbol = ko.observable();
                self.randomStockData = [];

                //Function for Adding new stock
                self.addStock = function () {
                    if (self.symbol() != undefined) {

                        //check for duplicate
                        for (var i = 0; i < FinanceHub.Data.Stocks.length; i++) {
                            if (FinanceHub.Data.Stocks.getAt(i).Symbol.toUpperCase() ==
                                self.symbol().toUpperCase())
                                return;
                        }

                        FinanceHub.Data.Stocks.push
                           (self.getNewStock(self.symbol().toUpperCase()));
                        self.stocksVM.push(new StockViewModel(self.symbol().toUpperCase()));
                        self.symbol("");
                    }
                }

                self.getNewStock = function (symbol) {
                    var num = Math.floor((Math.random() * 3) + 1);
                    var newStock = self.randomStockData[num];
                    newStock.Symbol = symbol;
                    return newStock;
                }

                //Parse SimulatedRandomStocksDetail.csv for sample data
                FinanceHub.LocalStorageHelper.
                    GetRandomStockData().then(function (csvData) {
                    csvData.forEach(showIteration);

                    function showIteration(value, index, array) {
                        self.randomStockData.push(new FinanceHub.Model.Stock
                            ("", value[0], value[1], value[2], value[3], value[4]));
                    }
                });
            })
    })
})();
```

上面的代码基本定义了 *addStock* 函数。该函数首先检查重复项，然后随机分配股票属性值，这些属性值是从*simulatedrandomstocksdail . CSV*文件中检索和解析的，这里我们使用了在 *LocalStorageHelper* 类中定义的 *GetRandomStockData* 函数。

上面代码中最重要的部分是使用了*self . symbol = ko . observable()；*语句。它定义了 *knockoutJS* 可观察对象。Observables 是特殊的 JavaScript 对象，可以通知订阅者变化，并可以自动更新 UI；在我们的例子中，一旦您添加了股票，它就会在视图中自动更新。

接下来选择并打开*default.html*文件，定位*addStockFlyout div**，*并应用绑定，如下图所示:

```cs
<div id="addStockFlyout" data-win-control="WinJS.UI.Flyout" >
        <div id="addStockFlyoutMessage"></div>
        <input id="addStockText"data-bind="value: symbol"
                   placeholder="Enter a symbol (e.g., MSFT)" />
        <br /><br />
        <button id="addStockButton"
                     data-bind="click:addStock" style="color:#fff">Add</button>
        <br /><br />
</div>
```

注意，与 WinJS 的 data-win-bind 类似，KnockoutJS 库也使用 *data-bind* 属性来定义绑定。这里我们将各自控件的*值*和按钮*点击*属性绑定到我们之前在 ViewModel 中创建的属性*符号*和*添加库存*。

最后一步是在 *default.js* 中实例化 ViewModel。为此，打开 *js* 文件夹下的 *default.js* 文件，找到*激活的*事件处理程序，修改代码，如下图所示:

```cs
WinJS.Binding.processAll(document.body, pageVM)
.then(function () {
    // Activates knockout.js
    ko.applyBindings(new FinanceHub.ViewModel.AddRemoveStockViewModel());
});
```

这里的 *ko.applyBindings* 方法激活 knockoutJS 和进程绑定。

如果您现在运行这个应用，那么您应该在主页上看到一个默认的 MSFT 股票以及相关的股票信息。在屏幕底部右键单击或滑动您的手指，以获得 Windows 应用栏。单击加号(添加)按钮，使用添加股票弹出按钮添加您选择的股票。

您会注意到，当您输入股票代码并单击 add 按钮时，股票将被添加，值将从 CSV 文件中分配并显示在 StocksPage 视图中。[图 6-6](#Fig6) 显示的是同样的情况，首页增加了两只股票。

![9781430249085_Fig06-06.jpg](img/-06.jpg)

[图 6-6。](#_Fig6)演示添加库存功能

[图 6-7](#Fig7) 显示添加了库存的库存详情视图，并显示库存 1 信息。

![9781430249085_Fig06-07.jpg](img/-07.jpg)

[图 6-7。](#_Fig7)添加了额外库存的库存详情视图

向视图模型添加移除库存功能

打开*addremovestockviewmodel . js*文件，定位*self . symbol = ko . observable()；*语句，并在其后添加以下语句来定义一个 *observableArray* 。

```cs
self.stocksVM = ko.observableArray();
```

现在，在 *FinanceHub 之后添加下面突出显示的代码。本地存储 helper . GetRandomStockData(*)调用 *AddRemoveStockViewModel* 文件。

```cs
WinJS.Namespace.define("FinanceHub.ViewModel", {
    AddRemoveStockViewModel: WinJS.Class.define(
        function () {

            var self = this;
            self.symbol = ko.observable();
            self.stocksVM = ko.observableArray();
            self.randomStockData = [];

            //Function for Adding new stock
            self.addStock = function () {
                if (self.symbol() != undefined) {

                    //check for duplicate
                    for (var i = 0; i < FinanceHub.Data.Stocks.length; i++) {
                        if (FinanceHub.Data.Stocks.getAt(i).Symbol.toUpperCase() ==
                            self.symbol().toUpperCase())
                            return;
                        }

                    FinanceHub.Data.Stocks.push(self.getNewStock(self.symbol().toUpperCase()));
                    self.stocksVM.push(new StockViewModel(self.symbol().toUpperCase()));
                    self.symbol("");
                }
            }

            self.getNewStock = function (symbol) {
                var num = Math.floor((Math.random() * 3) + 1);
                var newStock = self.randomStockData[num];
                newStock.Symbol = symbol;
                return newStock;
            }

            //Parse SimulatedRandomStocksDetail.csv for sample data
            FinanceHub.LocalStorageHelper.GetRandomStockData().then(function (csvData) {
                csvData.forEach(showIteration);

                function showIteration(value, index, array) {
                    self.randomStockData.push(new FinanceHub.Model.Stock
                        ("", value[0], value[1], value[2], value[3], value[4]));
                }
            });

            FinanceHub.Data.Stocks.forEach(showIteration);
            function showIteration(value, index, array) {

                self.stocksVM.push(new StockViewModel(value.Symbol));

            }

            //Function for removing the stock
            self.removeStock = function () {

                for (var i = this.stocksVM().length - 1; i >= 0; i--) {
                    if (self.stocksVM()[i].isSelected() == true) {
                        FinanceHub.Data.Stocks.splice(i, 1);
                        self.stocksVM.remove(self.stocksVM()[i]);
                    };

document.getElementById("removeStockFlyout").winControl.hide();
                }
            };

            function StockViewModel(data) {

                this.stock = ko.observable(data);
                this.isSelected = ko.observable(false);
            };
        })
})
```

这里， *forEach* 在*金融中心循环。Data.Stocks* 用于填充 *stocksVM* 数组，该数组是 *StockViewModel* 的一种类型。 *StockViewModel* 具有 *isSelected* 属性，该属性将告诉我们用户在 Remove stock 弹出菜单中选择的股票符号。

*removeStock* 方法从*金融中心删除选中的股票。数据.股票*以及*自有股票 sVM* 。请注意，我们正在根据检索到的商品索引移除库存，并使用*拼接*方法。这是因为，截至目前， *WinJS 中还没有 *removeAt* 这样的方法。Binding.List* 可用，支持通过索引移除项目。

接下来选择并打开*default.html*文件，定位移除 *StockFlyout div* ，应用如下高亮显示的绑定:

```cs
<div id="removeStockFlyout" data-win-control="WinJS.UI.Flyout"
        data-win-options="{width:'wide'}" >
        <table>
            <tbodydata-bind="foreach: stocksVM" >
                <tr>
                    <td >
                        <input type="checkbox"data-
bind="checked:isSelected" />
                         <spandata-bind="text: stock" ></span>
                    </td>
                </tr>
            </tbody>
        </table>
        <button id="Button1"
data-bind="click:removeStock" style="color:#fff">
                     Remove Selected</button>
        <br /><br />
</div>
```

在这里，我们绑定了所需的控件属性和按钮 *click* 属性，以填充现有股票并启用移除股票功能。

如果您此时运行应用，那么您应该得到一个默认的 MSFT 股票(注意，您输入的股票还没有保存！)与相关的股票信息。在屏幕底部右键单击或滑动您的手指，以获得 Windows 应用栏。点击加号(添加)按钮，使用“添加股票”弹出按钮添加您选择的几只股票。

接下来，单击应用栏上的减号(删除)按钮。这一次，您应该看到作为应用一部分的股票列表；您可以通过单击复选框来选择一个或多个，然后单击删除按钮来删除它们。[图 6-8](#Fig8) 展示了同样的情况。

![9781430249085_Fig06-08.jpg](img/-08.jpg)

[图 6-8。](#_Fig8)演示移除库存功能

请注意，添加和删除股票功能在股票页面和股票详细信息视图上都有效。

实现状态持续

到目前为止，您可以在运行应用时添加和删除股票。当您退出应用并重新运行时，添加的股票信息不会被保存，您将返回到默认的应用状态，MSFT 股票作为默认股票。

作为状态持久化的一部分，我们将把股票细节持久化到应用本地存储中的 CSV 文件中。为此，我们将使用 *WinJS。Application.local* 对象来存储和检索文件。我们将在现有的 JavaScript*LocalStorageHelper*类中开发两个额外的函数， *SaveStocks* 和 *LoadStocks* 函数来实现这样的功能。

储蓄股票功能

*保存股票*函数会将*股票*列表转换成 CSV 字符串，然后使用 *WinJS。Application.local.WriteText* 函数用于将文件写入应用本地存储区，并以 *StocksFile.csv* 文件名保存。

以下是该函数的完整代码，您需要在 *LocalStorageHelper.js* 文件中存在 *GetRandomStockData* 函数之后添加，该文件位于*常用*文件夹下。

```cs
stockFile: "StocksFile.csv",
csvString: "",
SaveStocks: function () {
    var app = WinJS.Application;
    FinanceHub.Data.Stocks.forEach(showIteration);
    function showIteration(value, index, array) {
        var temp = [];
        temp.push(value.Symbol);
        temp.push(value.OpenPrice);
        temp.push(value.CurrentPrice);
        temp.push(value.Change);
        temp.push(value.DaysRange);
        temp.push(value.Range52Week);
        FinanceHub.LocalStorageHelper.csvString =
            FinanceHub.LocalStorageHelper.csvString.concat(temp.join(), "\r\n");
    }

    app.local.writeText(FinanceHub.LocalStorageHelper.stockFile,
        FinanceHub.LocalStorageHelper.csvString);
},
```

装载功能

*LoadStocks* 函数将读取 *SaveStocks* 函数创建的 *StocksFile.csv* 。

以下是该函数的完整代码，您需要在 *LocalStorageHelper.js* 文件中存在 *SaveStocks* 函数之后添加，该文件位于*公共*文件夹下。

```cs
LoadStocks: function () {
    var app = WinJS.Application;

    return app.local.exists(FinanceHub.LocalStorageHelper.stockFile).then(function (exists)
   {
        if (exists)
            return app.local.readText(FinanceHub.LocalStorageHelper.stockFile).then(function (data)
           {
                return FinanceHub.LocalStorageHelper.ParseCSV(data);
            });
        else return null;
    });
},
```

检查状态持久性

当应用暂停或关闭时，您将通过在 *default.js* 文件中的 *app.oncheckpoint* 事件处理程序中放置以下代码来保存添加/删除的股票，该文件位于 *js* 文件夹下:

```cs
app.oncheckpoint = function (args) {
    // TODO: This application is about to be suspended. Save any state
    // that needs to persist across suspensions here. If you need to
    // complete an asynchronous operation before your application is
    // suspended, call args.setPromise().
    app.sessionState.history = nav.history;

    FinanceHub.LocalStorageHelper.SaveStocks();
};
```

![image](img/.jpg) **注意**调试控制菜单中的*暂停和关闭*选项只有在您运行项目时才会出现。出于某种原因，如果您在调试项目时没有找到该选项，请转到*工具/定制*选项，并选择*调试位置*工具栏项。

要恢复股票，我们需要修改 *WinJS 的函数。Binding.processAll* 中的 *default.js* ，如下高亮显示的代码:

```cs
WinJS.Binding.processAll(document.body, pageVM).then(function () {

    //Load previous state
    FinanceHub.LocalStorageHelper.LoadStocks().then(function (csvData) {
        if (csvData != null && csvData.length > 0) {
            csvData.forEach(showIteration);
        }
        else {
            FinanceHub.Data.Stocks.push(FinanceHub.Command.GetNewStock("MSFT"));
        }

        function showIteration(value, index, array) {
            if (value != "") {
                FinanceHub.Data.Stocks.push(new FinanceHub.Model.Stock
                   (value[0], value[1], value[2], value[3], value[4], value[5]));
            }
        }
    }).then(function () {

        // Activates knockout.js
        ko.applyBindings(new FinanceHub.ViewModel.AddRemoveStockViewModel());
    });
});
```

![image](img/.jpg) **注意**在这一点上，当你第一次编译和运行项目时，你可能会得到一个错误，而应用试图首先加载以前的状态。这是当前 WinRT RC 版本的一个潜在缺陷。我发现的解决方案是首先注释掉您刚刚在 *WinJS 中编写的代码。Binding.processAll* 函数将股票恢复回 default.js 文件*；*然后连线并运行项目。此时，您应该不会收到任何错误。现在，从 Debug Control 菜单中选择 *Suspend and Shutdown* 选项(仅在运行项目时出现)，这将暂停然后关闭应用。重新访问注释的代码并取消注释，从现在开始，您应该不会得到任何错误。

恭喜你！使用 JavaScript 和 HTML5，遵循 MVVM 设计模式，您已经完成了 Windows8 FinanceHub 应用的开发！运行项目(如果出现错误，请遵循上面的说明)，您应该看到所有实现的功能都在工作，包括保存到本地存储中的添加/删除的股票。然后在应用启动时，存储的股票将被检索，并被赋予随机值。

摘要

这是这本书的最后一章。在本章中，您创建了一个基于导航模板的 Windows 8 JavaScript 应用项目，并设置了支持基于 MVVM 的实现的结构。后来，我们开发了 FinanceHub 应用的视图、模型和视图模型，以及本书前面章节中使用 XAML 和 C#实现的所有功能。

本章演示了 Windows 8 应用平台是多功能的，支持不同的开发平台，包括 JavaScript 和 HTML5，并且可以遵循最佳和推荐的设计模式，如 MVVM。

不要忘记下载源代码。访问[第 6 章](6.html)文件夹，查看我们在本章开发的源代码。本章有一个特殊的源代码结构。您将在相关文件夹中找到视图、视图模型和模型实现的代码，以及整个项目的代码。

你已经开始了 Windows 8 应用开发的激动人心的旅程，我希望这本书能成功地引导你沿着它前进。祝你好运。