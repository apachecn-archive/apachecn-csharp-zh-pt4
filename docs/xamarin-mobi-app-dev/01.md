# 1.使用 Xamarin 进行移动开发

用 C#进行移动开发不同于我们大多数人以前用这种语言做过的任何事情。我们正在用它来开发非 Windows 平台的应用程序，即 Android 和 iOS。这既是机遇，也是挑战。机会是让我们接触丰富的技术，这些技术包括由不同平台和尺寸的手机和平板电脑组成的新商业应用生态系统。挑战在于，这些设备和平台对我们许多人来说都是新的，有很多东西需要学习。当然，我们也可以用 C#编写 Windows Phone 和平板电脑应用程序。跨平台开发的本质是构建可以在多种移动操作系统上运行的应用程序:例如，在 Android 和 iOS 上；或者在 iOS 和 Windows Phone 上；或者在 iOS、Android 和 Windows Phone 上。使用本书中涵盖的跨平台技术，您将能够为所有主要的移动平台进行开发！

这个旅程中最令人兴奋/恐怖的部分是学习几个操作系统的细节。幸运的是，Xamarin 屏蔽了许多细节，包装了特定于平台的 API 并公开了熟悉的。NET 使用 C#。相反，向我们详细展示的是每个平台的 C#包装的用户界面(UI)API，使我们能够精确控制应用程序的视觉设计。诀窍是理解每个操作系统的哪些方面在开发过程中是重要的，哪些可以留给 Xamarin。虽然在我们的理解中深入钻研无妨，但一天也就那么几个小时，底线是我们需要装运工作软件。

这些是关键问题:我们如何处理跨平台移动应用程序的开发？考虑到我们在 C#开发中已经有的历史和背景，我们如何在移动领域发扬这种知识并利用它呢？最后，考虑到要学习这些操作系统的很多东西，我们需要从什么开始并帮助解决这些重要的挑战呢？

在为多个平台编写应用程序时，一个关键目标是代码的重用。我们重用得越多，我们的项目就变得越快越便宜，我们的维护成本就越低。Xamarin 将此称为移动开发的独角兽:一次编写，随处部署。任何寻找独角兽的行动都是从一位美丽的少女引诱它出现开始的。我们的淑女是跨平台设计。

让我们探索 Xamarin 如何帮助我们解决移动难题，同时追求跨平台设计。

## 什么是 Xamarin？

Xamarin 是一个开发平台，允许我们用 C#编写本机、跨平台的 iOS、Android 和 Windows Phone 应用程序。

它是怎么做到的？继续读。

### 包装的本机 API

源自开源 Mono 项目。从. NET 到 Linux，Xamarin 平台是。NET 到支持 Windows Phone 的 iOS 和 Android 操作系统(见图 [1-1](#Fig1) )。基础 Xamarin。Android 是 Mono for Android，Xamarin.iOS 下面是 MonoTouch。这些是 C#绑定到原生 Android 和 iOS APIs，用于在移动和平板设备上开发。这为我们提供了 Android 和 iOS 用户界面、通知、图形、动画和手机功能(如位置和摄像头)的强大功能——所有这些都使用 C#。Android 和 iOS 操作系统的每个新版本都与一个新的 Xamarin 版本相匹配，该版本包括对其新 API 的绑定。Xamarin 的港口。NET 包括诸如数据类型、泛型、垃圾收集、语言集成查询(LINQ)、异步编程模式、委托和 Windows Communication Foundation(WCF)的子集等功能。库由链接器管理，只包含被引用的组件。Xamarin。Forms 是其他 UI 绑定和 Windows Phone API 之上的一层，它提供了一个完全跨平台的 UI 库。

![A978-1-4842-0214-2_1_Fig1_HTML.jpg](A978-1-4842-0214-2_1_Fig1_HTML.jpg)

图 1-1。

Xamarin C# libraries bind to native OS SDKs as well as .NET

因此，我们有了一个. NET 环境，其中包含 iOS 和 Android C#绑定的库，并支持在我们选择的移动操作系统上运行的 Windows Phone。太棒了。现在，我们如何使用这些库构建 ui 和编写代码来构建移动应用程序呢？当然是通过使用开发环境和 UI 设计器。

### 开发环境

Xamarin 提供开发环境和设计人员，帮助我们在 Windows 或 Mac 上构建移动应用。Xamarin 开发环境的两个主要选择是 Mac 或 Windows 上的 Xamarin Studio，或者 Windows 上带有 Xamarin for Windows 插件的 Visual Studio。iOS 应用的编译总是需要一台 Mac，即使使用 Visual Studio 作为开发环境。

### uidesigner

我们用来创建移动用户界面的工具叫做设计器。它们以各自专有的文件格式生成可扩展标记语言(XML)文件。Xamarin 提供两种设计器:

*   xamarin Android 设计器
*   用于 iOS 的 Xamarin 设计器

有了这些设计器，对原始的原生 XML 编辑器的需求就减少了。构建 Android 或 iOS UIs 可能需要的任何东西都可以在 Xamarin 的工具中找到。然而，iOS 开发人员仍然经常使用 Xcode 接口构建器，Android 开发人员(不太经常)使用 XML 编辑器，如 Eclipse 的 Android 开发工具(ADT)插件。XML 布局就是 XML 布局，工具在很大程度上是个人喜好和偏好的问题，甚至是使用设计工具的决定。一些 Xamarin 开发人员选择用 C#为所有平台手工编写 ui 代码，而不使用任何设计工具。我建议设计人员帮助学习文件格式、UI 元素及其属性。至少，使用像辅助轮这样的设计工具，直到你准备好自由泳。

Note

这本书关注的是代码而不是工具。有关 [`http://developer.xamarin.com`](http://developer.xamarin.com) 的设计器和开发环境的更多信息，请参考 Xamarin 在线文档。

## 旧的:熟悉的 C#和。网络技术

Xamarin 开发允许我们利用许多我们已经知道的关于 C#开发的东西。我们可以利用我们在以下方面的高级知识:

*   基于 HTML 的页面
*   可扩展应用程序标记语言(XAML)
*   用户界面控件
*   事件驱动逻辑
*   查看生命周期
*   状态管理
*   数据绑定
*   Web 服务

我们也可以用很多。特定于. NET 的技术，包括:

*   。网络数据类型
*   C#类、方法和属性
*   λ表达式
*   WCF(子集)
*   泛型(子集)
*   本地文件访问
*   流
*   异步/等待
*   ADO.NET(子集)

我只列举了几个，所以你可以看到 C#开发人员有很多熟悉的领域来帮助我们进入这个新领域。

## 新特性:移动开发技术

在本书中，你将探索移动开发中常见的 C#技术和模式。其中一些方法与我们习惯的传统方法完全相同。NET 开发，有的改了一点，少数改了很多。以下是关键主题:

*   移动 UI 是 C#移动开发最大的新学习领域。Xamarin。Forms 提供了一个跨平台的 UI 工具包，其中包含现成的表单、页面、布局、视图和控件。Xamarin.iOS 和 Xamarin。Android 提供了到各自本机 ui 的绑定。(参见[第二章](02.html)—[第六章](06.html)和[第八章](08.html)。)
*   移动应用程序中的数据访问层通常将控件和页面绑定到从本地数据库填充的数据模型，该数据库使用 web 服务与远程数据服务器同步。(参见[第七章](07.html)。)
*   通过 SQLite 访问本地数据库与通常的数据库供应商不同，尽管 ADO.NET access 提供了一个熟悉的入口，SQLite.NET 组件是一个很有特色的选项。(参见[第七章](07.html)。)
*   数据绑定是 Xamarin 的核心。表单开发，通常使用模型-视图-视图模型(MVVM)模式来完成。(参见[第七章](07.html)。)
*   跨平台架构是代码共享策略的集合，以进一步实现我们的一次编写，随处运行的目标。这些包括带有依赖注入的可移植类库(PCL)，共享文件和项目，以及条件编译。(参见[第九章](09.html)。)

让我们逐一讨论这些话题。

### 移动用户界面

当从 web 开发转移到跨平台移动开发时，您需要吸收大量的新知识，主要是在用户界面领域。首先是新操作系统 UI APIs 的问题。Xamarin 通过向使用 Xamarin 的主要操作系统提供特定于平台的 C#绑定来帮助解决这一问题。Android 和 Xamarin.iOS，而 Xamarin。Forms 提供了对这两者以及 Windows Phone 的跨平台绑定。另一组挑战涉及网络应用和移动应用之间的设计差异。紧凑的屏幕、触摸灵敏度和手持外形共同提供了一种全新的用户体验(UX)。这需要一种全新的设计和开发方法，引导我们探索移动 UI 设计。

#### Xamarin。表单和特定于平台的用户界面

使用 C#进行移动 UI 开发有两种主要方法，我们可以分别、互换或串联使用:

*   Xamarin。Forms 是一个适用于 Android、iOS 和 Windows Phone 的跨平台 UI 工具包。
*   特定于平台的 UI 使用 Xamarin。Android、Xamarin.iOS 和 Windows Phone SDK。

Xamarin。Forms 包含一个完全跨平台的工具包，它提供了一组 UI 控件、布局和页面，可以巧妙地映射到 iOS、Android 和 Windows Phone 上各自的本地 UI 绑定。自从 Xamarin。Forms 比特定于平台的库更新，但也没有那么全面。每个版本都让我们更接近全功能的跨平台优势，但有时我们需要的不仅仅是开箱即用的 Xamarin。表单类必须提供。在这些情况下，我们使用特定于平台的库，或者针对整个页面，或者只针对使用 Xamarin 的页面的一部分。形成名为`PageRenderers`的自定义渲染器。

特定于平台的方法更古老、更成熟，因此非常详细且功能全面。这涉及到直接绑定到特定于平台的 UI APIs 的库:Xamarin。Android 的 Android，iOS 的 Xamarin.iOS。对于 Windows Phone，我们使用 Windows Phone SDK，这是一个不需要 Xamarin 绑定的本地 API。这些特定于平台的库使我们能够深入访问本机 ui，以提供视觉上令人惊叹的交互式丰富用户体验。这是有代价的:特定于平台的代码要求每个平台都有一个单独的 UI 项目，代码可重用性很低。

Note

Xamarin。表单是这本书的主旨，通过使用特定于平台的 UI 的定制呈现器来增强。但是，开发人员使用 Xamarin.iOS 和 Xamarin 创建特定于平台的 UI 项目。没有 Xamarin 的 Android。表单可以很好地利用[第二章](02.html)—[第七章](07.html)中的 iOS 和 Android 部分。如果您采用特定于平台的方法，请务必参考其他关于 Xamarin 的资料(如 Xamarin 在线文档)。Android 和 Xamarin.iOS 解决方案设置和基础。

#### 移动用户界面设计

UI 技术构成了大多数移动软件开发的核心。当前小型设备的硬件限制鼓励我们将重担留给网络服务远端的 PC 和服务器。移动业务应用程序中运行的大多数组件都是为了支持可视用户界面。移动业务和数据访问层通常是它们的服务器端兄弟的缩略版本。这意味着我们最需要的是 UI 组件来帮助我们使用布局设计屏幕，实现数据输入和选择的控制，构建数据显示和编辑的列表和表格，创建用户导航，以及使用图像作为背景和图标。本书中的 UI 主题涵盖了移动应用程序开发中最常用的功能。在每一章中，我们从最简单的、最具跨平台性的方法开始，然后深入研究平台细节。本书涵盖了以下移动用户界面主题:

*   屏幕、视图或页面类似于 C#中的 web 和桌面，使用带有方法和属性的控件以及我们在控制器中处理的触发事件。(参见[第二章](02.html)。)
*   布局帮助我们组织控件的位置和格式，允许我们构造和设计移动应用程序的屏幕。(参见[第三章](03.html)。)
*   控件有助于用户交互和数据输入，这是移动用户界面所独有的，与 PC/鼠标界面有很大不同，主要是因为手势的使用。(参见[第四章](04.html)。)
*   列表是移动应用程序中最强大的数据显示和选择方法之一。(参见[第五章](05.html)。)
*   导航允许用户遍历应用程序，从一个屏幕移动到另一个屏幕，并访问功能。分层导航、模态屏幕、导航抽屉、警告、钻取列表和其他关键模式构成了移动 UI 导航的核心。(参见[第六章](06.html)。)
*   状态管理是指当用户在应用程序中导航时，处理在屏幕之间传递的数据。(参见[第六章](06.html)。)
*   在菜单、列表、网格、传送带和其他布局中，图像是移动体验的核心。(参见[第二章](02.html)、[第四章](04.html)、[第六章](06.html)。)

#### Xamarin。表单自定义渲染器

自定义渲染器允许我们比现成的 Xamarin 更深入。形成 UI 控件，并利用特定于平台的 UI 功能集，同时保持跨平台的方法。Xamarin。表单应用程序本质上是跨平台的，使用相同的代码库在所有三个主要平台上运行。这适用于基本设计和使用某些控件。然而，许多项目都需要更深入地使用 UI，例如单个控件上的细微设计差别、本机模式对话框、页面上的附加图形或动画，或者超出 Xamarin 范围的任何需求。表单在当前版本中提供。这是通过对本地控件进行子类化并实现`PageRenderers`来创建自定义控件来实现的，这些自定义控件使用 Xamarin.iOS 和 Xamarin.Android 来提供对特定于平台的 UI 功能的完全访问。这些特定于平台的控件可以在 Xamarin 中使用。表单页面来帮助维护跨平台架构。

### 数据访问层

移动数据访问层偏离了我们在 web 应用中习惯的设计，更类似于桌面应用中的设计。方法的复杂程度从流行的 MVVM 模式到模型-视图-控制器(MVC)再到基本的 CRUD(创建/插入/更新/删除)。数据绑定页面通常输入到设备上的本地数据库，该数据库使用 web 服务与远程数据服务器同步。

C#移动开发中的 Web 服务是代码重用的一个基本方面。对于移动应用程序来说，这些服务模式中的许多仍然与我们在构建 web 应用程序时所习惯的一样。然而，移动 web 服务更类似于桌面应用程序中的服务，与 web 应用程序服务的主要区别在于数据同步和离线使用的重要性。创建、更新和删除接口是在线公开的，用于来自多个平台和设备的 RESTful 调用。最美丽的少女居住在移动 web 服务模式中，这是一个跨平台、一次编写代码的完美场所。

与我们习惯的 web 应用程序相比，web 服务的服务器端组件对于移动应用程序来说保持不变，只是增加了与本地移动数据存储的数据同步，以供在线和离线使用。离线使用需要在本地数据库中保留一个基本数据集，并在连接可用时进行同步。并非所有应用都支持离线使用。

回顾我们在旧的相关技术中使用数据访问层的经验，我们将探索 C#移动应用程序中数据访问层的架构选项。

### 使用 SQLite 的本地数据访问

SQLite 是移动开发中最稳定、最可靠的跨平台数据库产品，它是一个开源项目，可以在 iOS、Android 和 Windows 设备上运行。Xamarin 向许多其他第三方项目推荐了它，这也是本书中涉及的内容。Xamarin 在开发环境中提供对 SQLite 数据库的访问和创建，为 ADO.NET 提供对 SQLite 的支持。还有一个 SQLite.NET Xamarin 组件，它是基于 C 的 SQLite 数据层的 C#包装器，提供对包含异步事务的 SQLite 数据库的低级访问。所有这些都使得连接到数据库、创建和索引表以及读取和写入行变得容易和容易。

### 数据绑定

使用 Xamarin.Forms 时，数据绑定是一致的且跨平台的。模仿 Windows Presentation Foundation(WPF)中的数据绑定，MVVM 模式是其实现的核心。在代码中，我们将控制字段绑定到数据模型，绑定机制是自动的。一个`PropertyChanged`事件的手动实现允许你的代码与数据源保持同步。绑定在代码或可扩展应用程序标记语言 XAML 中完成，可以是单向或双向的。控件、列表和文本被绑定到数据源或彼此的属性。越来越多的第三方供应商正在提供 Xamarin。包括数据绑定图表和网格的窗体控件套件，如 Telerik、Infragistics、Syncfusion 和 DevExpress。

Xamarin 中没有内置数据绑定。Android 和 Xamarin.iOS。特定于平台的数据绑定实现通常使用开源的第三方库，如 MvvmCross 和 MVVM 之光。

### 跨平台开发

以同样的方式。NET 提供了一个跨越许多操作系统和语言的统一基础设施，Xamarin 弥合了移动操作系统和它们各自的开发语言之间的差距:iOS 和 Objective-C，Android 和 Java，以及 Windows Phone 和平板电脑和 C#。通过这种方式，Xamarin 扩展了。NET 进入移动领域，远远超出了 Windows 操作系统。除了这非常酷的事实之外，这里的真正价值是在项目和平台之间共享和重用代码的机会。Xamarin 工具的最大好处在于跨平台代码；因此，移动模式的跨平台方法将产生最高的收益。Xamarin 工具为我们提供了一瞥“一次编写，随处部署”独角兽的方法。

我们在寻求跨平台实现时面临的最大敌人是特定于平台的代码。这些代码必须根据平台的不同而有所不同，无论是 iOS、Android 还是 Windows Phone。无论操作系统如何，跨平台模式都是相同的。跨平台代码有时被称为共享代码或核心代码，因为它在不同移动操作系统的项目之间共享。

Xamarin。表单解决了最棘手的跨平台挑战:用户界面。使用 Xamarin 的开发人员有一个完全跨平台的数据解决方案，这是使用 ADO.NET 或 SQLite.NET 和 SQLite 的本地数据访问，然后是 web 服务。尽管如此，总会有特定于平台的代码，如下所示:

*   在用户界面中
*   特定于设备的功能，如摄像头和位置
*   图形和动画
*   安全、文件和设备权限

一旦我们确定了特定于平台和跨平台的代码，接下来的问题就是如何将它组织成一个跨平台的架构。

我们有相当多的选择，从 PCL、共享项目、链接文件、接口、抽象和条件编译。PCL 提供了一种方法，使 C#组件可以用。NET 库编译成动态链接库(DLL ),该动态链接库可用于由 PCL 配置文件指定的任何平台的 Xamarin 项目中。数据访问层、客户端 web 服务和独立于平台的业务逻辑在这里和谐共存。通过对接口使用依赖注入，特定于平台的功能仍然可以被引入到这些库中。一种更宽松、更灵活的方法是使用包含为每个平台重新编译的核心文件的共享文件或项目。条件编译是一种古老的技术，非常适合小型的特定于平台的定制，它允许共享文件中的代码块包含在特定于平台的编译中。

我们将深入研究这些技术及其相关模式，因为它们带有独角兽的标志，帮助我们最大化代码的跨平台足迹。

## 摘要

商业应用正在经历硬件转型的巨变；自从个人电脑商业化以来，我们还没有见过如此巨大的变化。消费类移动设备的发展势头已经达到了一个临界点，影响了业务应用程序现在必须运行的设备。随着移动操作系统之间的战斗持续激烈，仅仅让一个移动应用程序在单一平台上运行已经不够了。

我们必须从一开始就考虑跨平台。

在的世界里。NET，Xamarin 为我们提供了让跨平台开发成为常态而不是特例的工具，所以我们没有借口。如果采用正确的方法，业务逻辑、数据访问层，甚至越来越多的 UI，大多都是独立于平台的。因此，无论你是在开发 Android、Windows Phone 还是 iOS 应用程序，对于应用程序的许多组件来说，这种方法在很大程度上是相同的。

让我们来看看代码！